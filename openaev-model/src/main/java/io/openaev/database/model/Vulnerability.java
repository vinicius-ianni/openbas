package io.openaev.database.model;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import io.openaev.annotation.Queryable;
import io.openaev.database.audit.ModelBaseListener;
import io.openaev.helper.MultiIdListSerializer;
import io.swagger.v3.oas.annotations.media.ArraySchema;
import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.math.BigDecimal;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import lombok.*;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.hibernate.annotations.UuidGenerator;

@Entity
@Table(name = "vulnerabilities")
@EntityListeners(ModelBaseListener.class)
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(onlyExplicitlyIncluded = true)
public class Vulnerability implements Base {

  public enum VulnerabilityStatus {
    ANALYZED,
    DEFERRED,
    MODIFIED,
  }

  @Id
  @Column(name = "vulnerability_id")
  @JsonProperty("vulnerability_id")
  @GeneratedValue(generator = "UUID")
  @UuidGenerator
  @EqualsAndHashCode.Include
  @NotBlank
  private String id;

  @Column(name = "vulnerability_external_id")
  @JsonProperty("vulnerability_external_id")
  @NotBlank
  @Queryable(searchable = true, filterable = true, sortable = true)
  private String externalId;

  @Column(name = "vulnerability_source_identifier")
  @JsonProperty("vulnerability_source_identifier")
  private String sourceIdentifier;

  @Column(name = "vulnerability_published")
  @JsonProperty("vulnerability_published")
  @Queryable(sortable = true)
  private Instant published;

  @Enumerated(EnumType.STRING)
  @Column(name = "vulnerability_vuln_status")
  @JsonProperty("vulnerability_vuln_status")
  private VulnerabilityStatus vulnStatus;

  @Column(name = "vulnerability_description")
  @JsonProperty("vulnerability_description")
  private String description;

  @Column(name = "vulnerability_remediation")
  @JsonProperty("vulnerability_remediation")
  private String remediation;

  @Column(name = "vulnerability_cisa_exploit_add")
  @JsonProperty("vulnerability_cisa_exploit_add")
  private Instant cisaExploitAdd;

  @Column(name = "vulnerability_cisa_action_due")
  @JsonProperty("vulnerability_cisa_action_due")
  private Instant cisaActionDue;

  @Column(name = "vulnerability_cisa_required_action")
  @JsonProperty("vulnerability_cisa_required_action")
  private String cisaRequiredAction;

  @Column(name = "vulnerability_cisa_vulnerability_name")
  @JsonProperty("vulnerability_cisa_vulnerability_name")
  private String cisaVulnerabilityName;

  @ElementCollection
  @CollectionTable(
      name = "vulnerability_reference_urls",
      joinColumns = @JoinColumn(name = "vulnerability_id"))
  @Column(name = "vulnerability_reference_url")
  @JsonProperty("vulnerability_reference_urls")
  private List<String> referenceUrls = new ArrayList<>();

  @NotNull
  @Column(name = "vulnerability_cvss_v31", precision = 3, scale = 1)
  @JsonProperty("vulnerability_cvss_v31")
  @Queryable(filterable = true, sortable = true)
  private BigDecimal cvssV31;

  @ArraySchema(schema = @Schema(type = "string"))
  @ManyToMany
  @JoinTable(
      name = "vulnerabilities_cwes",
      joinColumns = @JoinColumn(name = "vulnerability_id"),
      inverseJoinColumns = @JoinColumn(name = "cwe_id"))
  @JsonSerialize(using = MultiIdListSerializer.class)
  @JsonProperty("vulnerabilities_cwes")
  private List<Cwe> cwes = new ArrayList<>();

  // -- AUDIT --

  @CreationTimestamp
  @Queryable(filterable = true, sortable = true, label = "created at")
  @Column(name = "vulnerability_created_at", updatable = false)
  @JsonProperty("vulnerability_created_at")
  private Instant creationDate;

  @UpdateTimestamp
  @Queryable(filterable = true, sortable = true, label = "updated at")
  @Column(name = "vulnerability_updated_at")
  @JsonProperty("vulnerability_updated_at")
  private Instant updateDate;

  @Getter(onMethod_ = @JsonIgnore)
  @Transient
  private final ResourceType resourceType = ResourceType.VULNERABILITY;
}
